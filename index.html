<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PEDI - Sistema</title>

<style>
body{font-family:Arial;background:#111;color:#fff;text-align:center;margin:0;padding:20px}
input,button,select{padding:8px;margin:5px;border-radius:6px;border:none}
button{background:#00c853;color:#fff;cursor:pointer}
.card{background:#222;padding:15px;margin:10px;border-radius:10px}
img{width:100px;border-radius:8px}
h1{color:#00e676}
</style>
</head>
<body>

<h1>SISTEMA PEDI</h1>

<!-- LOGIN -->
<div id="authBox">
<h2>Registrar</h2>
<input id="regEmail" placeholder="Email">
<input id="regSenha" type="password" placeholder="Senha">
<input id="regTelefone" placeholder="Telefone com DDD">
<button onclick="registrar()">Registrar</button>

<h2>Login</h2>
<input id="loginEmail" placeholder="Email">
<input id="loginSenha" type="password">
<button onclick="login()">Entrar</button>
</div>

<!-- ADMIN -->
<div id="adminBox" style="display:none">
<h2>PAINEL ADMIN</h2>

<h3>Adicionar Produto</h3>
<input id="nomeProd" placeholder="Nome">
<input id="valorProd" placeholder="Valor">
<input id="localProd" placeholder="Local">
<input id="imgProd" placeholder="Link da imagem">
<button onclick="addProduto()">Adicionar</button>

<h3>Produtos</h3>
<div id="adminProdutos"></div>

<h3>Pedidos</h3>
<div id="adminPedidos"></div>

<button onclick="logout()">Sair</button>
</div>

<!-- CLIENTE -->
<div id="clienteBox" style="display:none">
<h2>PRODUTOS</h2>
<div id="listaProdutos"></div>

<h3>Entrega?</h3>
<select id="tipoEntrega">
<option value="retirada">Retirada</option>
<option value="entrega">Entrega</option>
</select>

<div id="enderecoBox" style="display:none">
<input id="cep" placeholder="CEP">
<button onclick="buscarCEP()">Buscar CEP</button><br>
<input id="rua" placeholder="Rua"><br>
<input id="numero" placeholder="Número"><br>
<input id="referencia" placeholder="Referência">
</div>

<button onclick="fazerPedido()">Fazer Pedido</button>

<h3>Meus Pedidos</h3>
<div id="meusPedidos"></div>

<button onclick="logout()">Sair</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBgqjGYaV7rmgLMPB-Y4DcvgVkg82GFt0I",
  authDomain: "sitepedidos.firebaseapp.com",
  projectId: "sitepedidos",
  storageBucket: "sitepedidos.firebasestorage.app",
  messagingSenderId: "812273915392",
  appId: "1:812273915392:web:eb939206a8dba04aca6ae5"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let carrinho=[];

/* REGISTRAR */
window.registrar = async ()=>{
  const email = regEmail.value;
  const senha = regSenha.value;
  const telefone = regTelefone.value;

  const user = await createUserWithEmailAndPassword(auth,email,senha);
  const snap = await getDocs(collection(db,"users"));

  const role = snap.size===0 ? "admin":"cliente";

  await addDoc(collection(db,"users"),{
    uid:user.user.uid,
    email,
    telefone,
    ddd:telefone.substring(0,2),
    role
  });

  alert("Conta criada como "+role);
};

/* LOGIN */
window.login = async ()=>{
  await signInWithEmailAndPassword(auth,loginEmail.value,loginSenha.value);
};

/* LOGOUT */
window.logout = async ()=>{
  await signOut(auth);
  location.reload();
};

/* MONITOR LOGIN */
onAuthStateChanged(auth, async user=>{
  if(!user) return;

  const q = query(collection(db,"users"),where("uid","==",user.uid));
  const snap = await getDocs(q);

  snap.forEach(docu=>{
    authBox.style.display="none";
    if(docu.data().role==="admin"){
      adminBox.style.display="block";
      carregarAdmin();
    }else{
      clienteBox.style.display="block";
      carregarProdutos();
      carregarPedidosCliente();
    }
  });
});

/* ADMIN */
window.addProduto = async ()=>{
  await addDoc(collection(db,"produtos"),{
    nome:nomeProd.value,
    valor:valorProd.value,
    local:localProd.value,
    imagem:imgProd.value,
    oculto:false
  });
};

function carregarAdmin(){
  onSnapshot(collection(db,"produtos"), snap=>{
    adminProdutos.innerHTML="";
    snap.forEach(docu=>{
      const p=docu.data();
      adminProdutos.innerHTML+=`
      <div class="card">
      <img src="${p.imagem}">
      <p>${p.nome} - R$${p.valor}</p>
      <button onclick="ocultar('${docu.id}')">Ocultar</button>
      <button onclick="remover('${docu.id}')">Remover</button>
      </div>`;
    });
  });

  onSnapshot(collection(db,"pedidos"), snap=>{
    adminPedidos.innerHTML="";
    snap.forEach(docu=>{
      const p=docu.data();
      adminPedidos.innerHTML+=`
      <div class="card">
      <p>Status: ${p.status}</p>
      <button onclick="atualizar('${docu.id}','A Caminho')">A Caminho</button>
      <button onclick="atualizar('${docu.id}','Concluído')">Concluído</button>
      </div>`;
    });
  });
}

window.ocultar=async id=>{
  await updateDoc(doc(db,"produtos",id),{oculto:true});
};

window.remover=async id=>{
  await deleteDoc(doc(db,"produtos",id));
};

window.atualizar=async (id,status)=>{
  await updateDoc(doc(db,"pedidos",id),{status});
};

/* CLIENTE */
function carregarProdutos(){
  onSnapshot(collection(db,"produtos"), snap=>{
    listaProdutos.innerHTML="";
    snap.forEach(docu=>{
      const p=docu.data();
      if(!p.oculto){
        listaProdutos.innerHTML+=`
        <div class="card">
        <img src="${p.imagem}">
        <p>${p.nome} - R$${p.valor}</p>
        <button onclick="addCarrinho('${p.nome}')">Adicionar</button>
        </div>`;
      }
    });
  });
}

window.addCarrinho=nome=>{
  carrinho.push(nome);
  alert("Adicionado");
};

tipoEntrega.onchange=()=>{
  enderecoBox.style.display = tipoEntrega.value==="entrega"?"block":"none";
};

window.buscarCEP=async ()=>{
  const res = await fetch(`https://viacep.com.br/ws/${cep.value}/json/`);
  const data = await res.json();
  rua.value=data.logradouro;
};

window.fazerPedido=async ()=>{
  let endereco="Retirada";
  if(tipoEntrega.value==="entrega"){
    endereco=rua.value+" Nº "+numero.value+" Ref: "+referencia.value;
  }

  await addDoc(collection(db,"pedidos"),{
    uid:auth.currentUser.uid,
    produtos:carrinho,
    endereco,
    status:"Recebido",
    data:new Date()
  });

  carrinho=[];
  alert("Pedido realizado!");
};

function carregarPedidosCliente(){
  const q=query(collection(db,"pedidos"),where("uid","==",auth.currentUser.uid));
  onSnapshot(q, snap=>{
    meusPedidos.innerHTML="";
    snap.forEach(docu=>{
      meusPedidos.innerHTML+=`
      <div class="card">
      Status: ${docu.data().status}
      </div>`;
    });
  });
}

</script>
</body>
</html>
