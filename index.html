<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Pedidos Completo</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">

<h1 class="text-2xl font-bold mb-4 text-center">Sistema de Pedidos</h1>

<div id="loginArea">
<input id="email" placeholder="Email" class="p-2 bg-gray-700 mb-2 w-full">
<input id="senha" type="password" placeholder="Senha" class="p-2 bg-gray-700 mb-2 w-full">
<button onclick="cadastrar()" class="bg-green-600 p-2 w-full mb-2">Cadastrar</button>
<button onclick="login()" class="bg-blue-600 p-2 w-full">Entrar</button>
</div>

<div id="adminArea" class="hidden">
<h2 class="text-xl mt-4">Admin</h2>

<input id="prodNome" placeholder="Nome produto" class="p-2 bg-gray-700 mb-2 w-full">
<input id="prodValor" placeholder="Valor" class="p-2 bg-gray-700 mb-2 w-full">
<input id="prodImg" placeholder="URL imagem" class="p-2 bg-gray-700 mb-2 w-full">

<button onclick="addProduto()" class="bg-green-600 p-2 w-full mb-2">Adicionar Produto</button>

<h3 class="mt-4">Produtos</h3>
<div id="listaAdminProdutos"></div>

<h3 class="mt-4">Pedidos</h3>
<div id="listaPedidos"></div>

<button onclick="logout()" class="bg-red-600 p-2 w-full mt-4">Sair</button>
</div>

<div id="clienteArea" class="hidden">
<h2 class="text-xl mt-4">Produtos</h2>
<div id="listaProdutos"></div>

<h3 class="mt-4">Carrinho</h3>
<div id="carrinho"></div>

<input id="cep" placeholder="CEP" class="p-2 bg-gray-700 mt-2 w-full">
<input id="numero" placeholder="Número" class="p-2 bg-gray-700 mt-2 w-full">
<input id="ref" placeholder="Referência" class="p-2 bg-gray-700 mt-2 w-full">

<button onclick="buscarCep()" class="bg-yellow-600 p-2 w-full mt-2">Buscar CEP</button>
<button onclick="fazerPedido()" class="bg-green-600 p-2 w-full mt-2">Fazer Pedido</button>

<h3 class="mt-4">Meus Pedidos</h3>
<div id="meusPedidos"></div>

<button onclick="logout()" class="bg-red-600 p-2 w-full mt-4">Sair</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/12.10.0/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, doc, setDoc, getDoc, deleteDoc, updateDoc, onSnapshot }
from "https://www.gstatic.com/firebasejs/12.10.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "SUA_API_AQUI",
  authDomain: "SEU_DOMINIO.firebaseapp.com",
  projectId: "SEU_PROJECT_ID",
  storageBucket: "SEU_BUCKET",
  messagingSenderId: "SEU_ID",
  appId: "SEU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userRole = null;
let carrinho = [];

window.cadastrar = async () => {
  const cred = await createUserWithEmailAndPassword(auth,email.value,senha.value);
  const users = await getDocs(collection(db,"users"));
  const role = users.size === 0 ? "admin" : "cliente";
  await setDoc(doc(db,"users",cred.user.uid),{email:email.value,role});
  alert("Conta criada como "+role);
}

window.login = async () => {
  await signInWithEmailAndPassword(auth,email.value,senha.value);
}

window.logout = () => signOut(auth);

onAuthStateChanged(auth, async (user)=>{
  if(!user){
    loginArea.classList.remove("hidden");
    adminArea.classList.add("hidden");
    clienteArea.classList.add("hidden");
    return;
  }

  const snap = await getDoc(doc(db,"users",user.uid));
  userRole = snap.data().role;
  loginArea.classList.add("hidden");

  if(userRole==="admin"){
    adminArea.classList.remove("hidden");
    carregarProdutosAdmin();
    carregarPedidosAdmin();
  } else {
    clienteArea.classList.remove("hidden");
    carregarProdutos();
    carregarMeusPedidos();
  }
});

async function addProduto(){
  await addDoc(collection(db,"products"),{
    nome:prodNome.value,
    valor:prodValor.value,
    imagem:prodImg.value,
    ativo:true
  });
}

function carregarProdutosAdmin(){
  onSnapshot(collection(db,"products"),snap=>{
    listaAdminProdutos.innerHTML="";
    snap.forEach(docu=>{
      const p=docu.data();
      listaAdminProdutos.innerHTML+=`
      <div class="border p-2 mt-2">
        ${p.nome} - R$${p.valor}
        <button onclick="removerProduto('${docu.id}')" class="bg-red-600 p-1">Remover</button>
      </div>`;
    });
  });
}

window.removerProduto = async(id)=>{
  await deleteDoc(doc(db,"products",id));
}

function carregarProdutos(){
  onSnapshot(collection(db,"products"),snap=>{
    listaProdutos.innerHTML="";
    snap.forEach(docu=>{
      const p=docu.data();
      if(!p.ativo) return;
      listaProdutos.innerHTML+=`
      <div class="border p-2 mt-2">
        <img src="${p.imagem}" width="50">
        ${p.nome} - R$${p.valor}
        <button onclick="addCarrinho('${p.nome}',${p.valor})" class="bg-green-600 p-1">Adicionar</button>
      </div>`;
    });
  });
}

window.addCarrinho=(nome,valor)=>{
  carrinho.push({nome,valor});
  renderCarrinho();
}

function renderCarrinho(){
  carrinho.innerHTML="";
}

window.buscarCep=async()=>{
  const res=await fetch(`https://viacep.com.br/ws/${cep.value}/json/`);
  const data=await res.json();
  alert("Rua: "+data.logradouro);
}

window.fazerPedido=async()=>{
  await addDoc(collection(db,"orders"),{
    user:auth.currentUser.uid,
    produtos:carrinho,
    status:"pendente"
  });
  carrinho=[];
  alert("Pedido enviado");
}

function carregarPedidosAdmin(){
  onSnapshot(collection(db,"orders"),snap=>{
    listaPedidos.innerHTML="";
    snap.forEach(docu=>{
      const o=docu.data();
      listaPedidos.innerHTML+=`
      <div class="border p-2 mt-2">
        Pedido - ${o.status}
        <button onclick="mudarStatus('${docu.id}','confirmado')" class="bg-blue-600 p-1">Confirmar</button>
      </div>`;
    });
  });
}

window.mudarStatus=async(id,status)=>{
  await updateDoc(doc(db,"orders",id),{status});
}

function carregarMeusPedidos(){
  onSnapshot(collection(db,"orders"),snap=>{
    meusPedidos.innerHTML="";
    snap.forEach(docu=>{
      const o=docu.data();
      if(o.user===auth.currentUser.uid){
        meusPedidos.innerHTML+=`<div class="border p-2 mt-2">Status: ${o.status}</div>`;
      }
    });
  });
}
</script>

</body>
</html>
